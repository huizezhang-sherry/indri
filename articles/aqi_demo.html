<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>AQI Demo • tidyindex</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="AQI Demo">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyindex</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/tidyindex.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/aqi_demo.html">AQI Demo</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/huizezhang-sherry/tidyindex/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="aqi_demo_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>AQI Demo</h1>
                        <h4 data-toc-skip class="author">Walter Wang, Sherry Zhang</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/huizezhang-sherry/tidyindex/blob/main/vignettes/aqi_demo.Rmd" class="external-link"><code>vignettes/aqi_demo.Rmd</code></a></small>
      <div class="d-none name"><code>aqi_demo.Rmd</code></div>
    </div>

    
    
<p>Below we will introduce Air Quality Index (AQI), and demonstrate how to use tidyindex package to compute it based on existing datasets.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://huizezhang-sherry.github.io/tidyindex/" class="external-link">tidyindex</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="everything-about-aqi">1. Everything about AQI<a class="anchor" aria-label="anchor" href="#everything-about-aqi"></a>
</h2>
<p>The Air Quality Index (AQI) is an index created to measure air quality, with high values indicating greater pollution levels. The index categorized into six levels, each corresponding to a specific numerical range:</p>
<ul>
<li>Good (0 - 50),</li>
<li>Moderate (50 - 100),</li>
<li>Unhealthy for Sensitive Groups (101 - 150),</li>
<li>Unhealthy (151 - 200),</li>
<li>Very Unhealthy (201 - 300), and</li>
<li>Hazardous (300 and higher).</li>
</ul>
<p>The AQI is calculated individually for each of the six major pollutants: Ozone (O3), PM2.5, PM10, Carbon Monoxide (CO), Sulfur Dioxide (SO2), Nitrogen Dioxide (NO2). The pollution concentrations are first truncated, and then the AQI value for each pollutant is calculated based on the following equation:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">p</mtext></msub><mo>=</mo><mfrac><mrow><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Hi</mtext></msub><mo>−</mo><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Lo</mtext></msub></mrow><mrow><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Hi</mtext></msub><mo>−</mo><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Lo</mtext></msub></mrow></mfrac><mo stretchy="false" form="prefix">(</mo><msub><mtext mathvariant="normal">C</mtext><mtext mathvariant="normal">p</mtext></msub><mo>−</mo><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Lo</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Lo</mtext></msub><mi>.</mi></mrow><annotation encoding="application/x-tex">\text{I}_\text{p} = \frac{\text{I}_\text{Hi} - \text{I}_\text{Lo}}{\text{BP}_\text{Hi} - \text{BP}_\text{Lo}}(\text{C}_\text{p} - \text{BP}_\text{Lo}) + \text{I}_\text{Lo}.</annotation></semantics></math> where:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">p</mtext></msub><annotation encoding="application/x-tex">\text{I}_\text{p}</annotation></semantics></math> is the AQI for pollutant <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">p</mtext><annotation encoding="application/x-tex">\text{p}</annotation></semantics></math>,</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">C</mtext><mtext mathvariant="normal">p</mtext></msub><annotation encoding="application/x-tex">\text{C}_\text{p}</annotation></semantics></math> is the truncated concentration of pollutant <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">p</mtext><annotation encoding="application/x-tex">\text{p}</annotation></semantics></math>,</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Hi</mtext></msub><annotation encoding="application/x-tex">\text{BP}_\text{Hi}</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Lo</mtext></msub><annotation encoding="application/x-tex">\text{BP}_\text{Lo}</annotation></semantics></math> are the high and low concentration breakpoints of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">C</mtext><mtext mathvariant="normal">p</mtext></msub><annotation encoding="application/x-tex">\text{C}_\text{p}</annotation></semantics></math>,</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Hi</mtext></msub><annotation encoding="application/x-tex">\text{I}_\text{Hi}</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Lo</mtext></msub><annotation encoding="application/x-tex">\text{I}_\text{Lo}</annotation></semantics></math> are the AQI values corresponding to <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Hi</mtext></msub><annotation encoding="application/x-tex">\text{BP}_\text{Hi}</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Lo</mtext></msub><annotation encoding="application/x-tex">\text{BP}_\text{Lo}</annotation></semantics></math>, respectively.</p></li>
</ul>
<p>Each individual AQI value is rounded to the nearest integer, and the highest value among the six pollutant is taken as the final AQI.</p>
<p>The breakpoint values for each pollutant are provided in Table 6 of the <a href="https://document.airnow.gov/technical-assistance-document-for-the-reporting-of-daily-air-quailty.pdf" class="external-link">Technical Assistance Document for the Reporting of Daily Air Quality</a>.</p>
<p>As an example, with an 8-hour measurement of CO value of 4.67, this value is first truncate to 4.6. For CO concentrations ranging from 4.5 to 9.4, the corresponding AQI range is 51 to 100. Using the formula above, the AQI is calculated as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mn>100</mn><mo>−</mo><mn>51</mn></mrow><mrow><mn>9.4</mn><mo>−</mo><mn>4.5</mn></mrow></mfrac><mo>×</mo><mo stretchy="false" form="prefix">(</mo><mn>4.6</mn><mo>−</mo><mn>4.5</mn><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mn>51</mn><mo>=</mo><mn>75.01</mn><mo>,</mo></mrow><annotation encoding="application/x-tex">\frac{100 - 51}{9.4 - 4.5}\times(4.6 - 4.5) + 51 = 75.01,</annotation></semantics></math> This gives an AQI value of 75 for CO after rounding.</p>
</div>
<div class="section level2">
<h2 id="data">2. Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>To obtain all AQI-related data, we use the aqsr package, which provides an R interface for the EPA Air Quality System (AQS) API. For details about how to use the package, see the <a href="https://github.com/kpkeller/aqsr" class="external-link">aqsr GitHub repository</a>.</p>
<p>In this repository, we have provided some AQI data for convenience. <code>aqi_travis</code> contains the PM2.5 values in Travis county, Austin, Texas, USA from 2024/01/01 to 2024/03/31, measured at three monitor sites. <code>aqi_table</code> and <code>pollutant_table</code> contain breakpoint values for AQI and six major pollutants, respectively.</p>
</div>
<div class="section level2">
<h2 id="tidyindex-demonstration">3. Tidyindex Demonstration<a class="anchor" aria-label="anchor" href="#tidyindex-demonstration"></a>
</h2>
<p>In this section, we will demonstrate how to use tidyindex to compute AQI.</p>
<div class="section level3">
<h3 id="load-datasets">3.1 Load Datasets<a class="anchor" aria-label="anchor" href="#load-datasets"></a>
</h3>
<p>First, let’s load the dataset:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aqi</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 272 × 9</span></span></span>
<span><span class="co">#&gt;    pollutant  code date       value   aqi  long   lat site_code site_name       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-01  10      53 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-02   9.1    51 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-03   7.1    39 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-04  10.3    53 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-05   3.7    21 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-06   4.5    25 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-07   6.2    34 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-08   7.5    42 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-09   2.7    15 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> PM2.5     <span style="text-decoration: underline;">88</span>101 2024-01-10   7.5    42 -<span style="color: #BB0000;">97.8</span>  30.4        14 Austin North Hi…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 262 more rows</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="find-breakpoints">3.2 Find Breakpoints<a class="anchor" aria-label="anchor" href="#find-breakpoints"></a>
</h3>
<p>According to the equation given in section 1, to compute AQI, we need to find the high and low breakpoints for every sample measurement, as well as the corresponding AQI breakpoints. We can use the following helper functions to lookup the breakpoint information.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lookup_helper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample</span>, <span class="va">subset</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">subset</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample</span> <span class="op">&gt;=</span> <span class="va">low</span> <span class="op">&amp;</span> <span class="va">sample</span> <span class="op">&lt;=</span> <span class="va">high</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">aqi_lookup</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># takes the dataset of measurements as input</span></span>
<span>  <span class="co"># returns a tibble object with corresponding breakpoints and group info</span></span>
<span>  <span class="va">id</span> <span class="op">&lt;-</span> <span class="va">dataset</span><span class="op">$</span><span class="va">code</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">concentration</span> <span class="op">&lt;-</span> <span class="va">dataset</span><span class="op">$</span><span class="va">value</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="st">"44201"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">concentration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">trunc</a></span><span class="op">(</span><span class="va">concentration</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">^</span><span class="fl">3</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="st">"88101"</span> <span class="op">|</span> <span class="va">id</span> <span class="op">==</span> <span class="st">"42101"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">concentration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">trunc</a></span><span class="op">(</span><span class="va">concentration</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">concentration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">trunc</a></span><span class="op">(</span><span class="va">concentration</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">subset</span> <span class="op">&lt;-</span> <span class="va">pollutant_ref_tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">code</span> <span class="op">==</span> <span class="va">id</span><span class="op">)</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">concentration</span>, <span class="op">~</span> <span class="fu">lookup_helper</span><span class="op">(</span><span class="va">.x</span>, <span class="va">subset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">aqi</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">pollutant</span>, <span class="op">-</span><span class="va">code</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, the <code>lookup_helper</code> function will find the high and low breakpoints for any given samples. The <code>aqi_lookup</code> function first truncates every measurement according to different types of pollutants, then calls <code>lookup_helper</code> to return a tibble object, which contains every sample measurement, their corresponding high/low breakpoints, and group information.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">breakpoints</span> <span class="op">&lt;-</span> <span class="fu">aqi_lookup</span><span class="op">(</span><span class="va">aqi</span><span class="op">)</span></span>
<span><span class="va">breakpoints</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 272 × 12</span></span></span>
<span><span class="co">#&gt;    pollutant  code group            low  high date       value   aqi  long   lat</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Unhealthy        9.1  35.4 2024-01-01  10      53 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Unhealthy        9.1  35.4 2024-01-02   9.1    51 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-03   7.1    39 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Unhealthy        9.1  35.4 2024-01-04  10.3    53 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-05   3.7    21 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-06   4.5    25 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-07   6.2    34 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-08   7.5    42 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-09   2.7    15 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> PM2.5     <span style="text-decoration: underline;">88</span>101 Very Unhealthy   0     9   2024-01-10   7.5    42 -<span style="color: #BB0000;">97.8</span>  30.4</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 262 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: site_code &lt;dbl&gt;, site_name &lt;chr&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="initialize-tidyindex-pipeline">3.3 Initialize Tidyindex Pipeline<a class="anchor" aria-label="anchor" href="#initialize-tidyindex-pipeline"></a>
</h3>
<p>With all preparation done, let’s now initialize the tidyindex pipeline.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span><span class="va">breakpoints</span><span class="op">)</span></span></code></pre></div>
<div class="section level5">
<h5 id="note-that-to-efficiently-use-the-tidyindex-pipeline-it-is-recommended-to-put-all-needed-data-columns-into-one-single-dataframe-or-tibble-object-as-we-have-in-breakpoints-">Note that to efficiently use the tidyindex pipeline, it is recommended to put all needed data columns into one single dataframe or tibble object, as we have in <code>breakpoints</code>.<a class="anchor" aria-label="anchor" href="#note-that-to-efficiently-use-the-tidyindex-pipeline-it-is-recommended-to-put-all-needed-data-columns-into-one-single-dataframe-or-tibble-object-as-we-have-in-breakpoints-"></a>
</h5>
<p>Upon inspection of the AQI equation in section 1, we know that the computation of AQI could be decomposed into two parts: a min-max rescaling with <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">min</mtext><mo>=</mo><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Lo</mtext></msub></mrow><annotation encoding="application/x-tex">\text{min} = \text{BP}_\text{Lo}</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">max</mtext><mo>=</mo><msub><mtext mathvariant="normal">BP</mtext><mtext mathvariant="normal">Hi</mtext></msub></mrow><annotation encoding="application/x-tex">\text{max} = \text{BP}_\text{Hi}</annotation></semantics></math>, as well as a transformation, which multiplies <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Hi</mtext></msub><mo>−</mo><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Lo</mtext></msub></mrow><annotation encoding="application/x-tex">\text{I}_\text{Hi} - \text{I}_\text{Lo}</annotation></semantics></math> and then adds <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">I</mtext><mtext mathvariant="normal">Lo</mtext></msub><annotation encoding="application/x-tex">\text{I}_\text{Lo}</annotation></semantics></math>.</p>
<p>Therefore, we can easily construct the pipeline using the <code><a href="../reference/rescale.html">rescaling()</a></code> and <code>variable_transformation()</code> modules provided in tidyindex.</p>
</div>
</div>
<div class="section level3">
<h3 id="rescaling">3.4 Rescaling<a class="anchor" aria-label="anchor" href="#rescaling"></a>
</h3>
<p>The minmax rescaling is done by calling the <code><a href="../reference/rescale.html">rescale_minmax()</a></code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="va">pipeline</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/rescale.html">rescaling</a></span><span class="op">(</span>minmax <span class="op">=</span> <span class="fu"><a href="../reference/rescale.html">rescale_minmax</a></span><span class="op">(</span><span class="va">value</span>, min <span class="op">=</span> <span class="va">low</span>, max <span class="op">=</span> <span class="va">high</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/rescale.html">rescale_minmax()</a></code> function supports vectorized data inputs, so here we can just leave <code>sample_measurements</code>, <code>low_breakpoint</code> and <code>high_breakpoint</code> as vectors from <code>breakpoints</code>, and the function will automatically perform the minmax rescaling across every single data entry. The rescaling results are stored in the <code>minmax</code> column added to the pipeline.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pollutant</span>, <span class="va">date</span>, <span class="va">low</span>, <span class="va">high</span>, <span class="va">value</span>, <span class="va">minmax</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 272 × 6</span></span></span>
<span><span class="co">#&gt;    pollutant date         low  high value minmax</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> PM2.5     2024-01-01   9.1  35.4  10   0.034<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> PM2.5     2024-01-02   9.1  35.4   9.1 0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> PM2.5     2024-01-03   0     9     7.1 0.789 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> PM2.5     2024-01-04   9.1  35.4  10.3 0.045<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> PM2.5     2024-01-05   0     9     3.7 0.411 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> PM2.5     2024-01-06   0     9     4.5 0.5   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> PM2.5     2024-01-07   0     9     6.2 0.689 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> PM2.5     2024-01-08   0     9     7.5 0.833 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> PM2.5     2024-01-09   0     9     2.7 0.3   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> PM2.5     2024-01-10   0     9     7.5 0.833 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 262 more rows</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="variable-transformation">3.5 Variable Transformation<a class="anchor" aria-label="anchor" href="#variable-transformation"></a>
</h3>
<p>Next step is variable transformation, where we wish to multiply and add to the original variable. Such transformation is called affine transformation. While it is not already written in <code>tidyindex</code>, one can always come up with and implement their customized transformation functions, as well as other necessary functions. For our case, the transformation could be implemented by adding the following lines:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @rdname variable-transformation</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">trans_affine</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var</span>, <span class="va">a</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">b</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">a</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">b</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="va">a</span><span class="op">*</span><span class="va">x</span> <span class="op">+</span> <span class="va">b</span></span>
<span>  <span class="fu">new_trans</span><span class="op">(</span><span class="st">"trans_affine"</span>, var <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">fn</span>, a <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, we name it as <code>trans_affine</code>, and it has three inputs: <code>var</code>, the variable that will be transformed; <code>a</code>, the multiplicative coefficient, and <code>b</code>, the additive constant. These inputs will be used in the next line to construct the transformation function <code>fn</code>, which has our desired form <code>a*x + b</code>. Then, we create the <code>trans_affine</code> function by calling <code>new_trans()</code>, which will register the name, as well as all other inputs including the variable itself, the transformation function <code>fn</code>, and parameters <code>a</code> and <code>b</code>.</p>
<div class="section level5">
<h5 id="note-here-we-put-enquo-around-a-and-b-to-make-sure-they-are-being-evaluated-in-quosure-so-that-we-can-find-them-in-the-dataframe--otherwise-we-will-have-to-manually-create-these-variables-and-pass-them-to-the-function-for-evaluation-">Note: here we put <code>enquo()</code> around <code>a</code> and <code>b</code> to make sure they are being evaluated in quosure, so that we can find them in the dataframe. Otherwise we will have to manually create these variables and pass them to the function for evaluation.<a class="anchor" aria-label="anchor" href="#note-here-we-put-enquo-around-a-and-b-to-make-sure-they-are-being-evaluated-in-quosure-so-that-we-can-find-them-in-the-dataframe--otherwise-we-will-have-to-manually-create-these-variables-and-pass-them-to-the-function-for-evaluation-"></a>
</h5>
<p>With the implemented transformation, we can now finish our pipeline.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="va">pipeline</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/variable-transformation.html">variable_trans</a></span><span class="op">(</span>AQI <span class="op">=</span> <span class="fu"><a href="../reference/variable-transformation.html">trans_affine</a></span><span class="op">(</span><span class="va">minmax</span>, a <span class="op">=</span> <span class="va">high</span> <span class="op">-</span> <span class="va">low</span>, b <span class="op">=</span> <span class="va">low</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AQI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AQI</span><span class="op">)</span></span>
<span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pollutant</span>, <span class="va">date</span>, <span class="va">low</span>, <span class="va">high</span>, <span class="va">value</span>, <span class="va">minmax</span>, <span class="va">AQI</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 272 × 7</span></span></span>
<span><span class="co">#&gt;    pollutant date         low  high value minmax   AQI</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> PM2.5     2024-01-01   9.1  35.4  10   0.034<span style="text-decoration: underline;">2</span>    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> PM2.5     2024-01-02   9.1  35.4   9.1 0          9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> PM2.5     2024-01-03   0     9     7.1 0.789      7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> PM2.5     2024-01-04   9.1  35.4  10.3 0.045<span style="text-decoration: underline;">6</span>    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> PM2.5     2024-01-05   0     9     3.7 0.411      4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> PM2.5     2024-01-06   0     9     4.5 0.5        4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> PM2.5     2024-01-07   0     9     6.2 0.689      6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> PM2.5     2024-01-08   0     9     7.5 0.833      8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> PM2.5     2024-01-09   0     9     2.7 0.3        3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> PM2.5     2024-01-10   0     9     7.5 0.833      8</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 262 more rows</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="visualization">4. Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h2>
<p>Now let’s check our results. Below we show a line graph with AQI values from all three monitor sites, computed using our pipeline.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pipeline</span><span class="op">$</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">AQI</span>, color <span class="op">=</span> <span class="va">site_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"AQI Values Over Time by Site"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"AQI"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Monitor Sites"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_labels <span class="op">=</span> <span class="st">"%b %Y"</span>, date_breaks <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="aqi_demo_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by H. Sherry Zhang, Dianne Cook, Ursula Laa, Nicolas Langrené, Patricia Menéndez.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
